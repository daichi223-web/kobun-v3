const fs = require('fs');
const path = require('path');
const dir = 'app/data/grammar';

// --- keyPoints and studySteps for each topic ---
const topicData = {
  'doushi-katsuyo': {
    keyPoints: [
      '「ず」を付けて未然形の段を確認 → 活用型を判定する（ア段=四段、イ段=上二段、エ段=下二段）',
      '変格活用（カ変・サ変・ナ変・ラ変）は該当する動詞が限られるので丸暗記',
      '上一段は「ひいきにみゐる」で覚える。下一段は「蹴る」のみ'
    ],
    studySteps: [
      '9種類の活用型の名前を覚える（四段・上二段・下二段・上一段・下一段・カ変・サ変・ナ変・ラ変）',
      '「ず」を付けて未然形の段を確認する方法を身につける',
      '変格活用と上一段の動詞を暗記する',
      '四段・上二段・下二段の活用表を書けるようにする'
    ]
  },
  'doushi-yodan': {
    keyPoints: [
      '古文で最も多い活用型。迷ったらまず四段を疑う',
      '「ず」を付けて未然形がア段 → 四段活用と判定'
    ],
    studySteps: [
      '「ず」を付ける → 未然形を確認',
      'ア段なら四段。イ段なら上二段、エ段なら下二段',
      '活用表を暗記: か・き・く・く・け・け（カ行の例）'
    ]
  },
  'doushi-shimo-nidan': {
    keyPoints: [
      '「ず」を付けて未然形がエ段 → 下二段活用',
      '「いらふ（答ふ）」「寝（ぬ）」など一文字動詞は特に注意'
    ],
    studySteps: [
      '「ず」を付けて未然形を確認 → エ段なら下二段',
      '活用表を暗記: え・え・う・うる・うれ・えよ',
      '一文字動詞「得（う）」「寝（ぬ）」「経（ふ）」を覚える'
    ]
  },
  'doushi-kami-ichidan': {
    keyPoints: [
      '「ひいきにみゐる」で覚える（干る・射る・着る・似る・見る・居る）',
      '語幹がなく一文字。上二段と紛らわしいので暗記が必要'
    ],
    studySteps: [
      '「ひいきにみゐる」を暗記する',
      '活用表: イ段のみで変化（○・○・いる・いる・いれ・いよ）',
      '上二段との区別: 上一段に該当しなければ上二段'
    ]
  },
  'doushi-kahen': {
    keyPoints: [
      '「来（く）」一語のみ。丸暗記すれば確実に得点できる',
      '活用: こ・き・く・くる・くれ・こよ'
    ],
    studySteps: [
      '「来」がカ変であることを覚える',
      '活用表を暗記: こ・き・く・くる・くれ・こよ',
      '複合動詞「出で来」もカ変であることを確認'
    ]
  },
  'doushi-sahen': {
    keyPoints: [
      '「す」「おはす」の2語のみ。「〜す」の複合動詞も全てサ変',
      '活用: せ・し・す・する・すれ・せよ'
    ],
    studySteps: [
      '「す」と「おはす」がサ変であることを覚える',
      '活用表を暗記: せ・し・す・する・すれ・せよ',
      '「念じす」「奏す」など「〜す」型の複合動詞もサ変'
    ]
  },
  'doushi-rahen': {
    keyPoints: [
      '「あり・をり・はべり・いまそかり」の4語のみ',
      '終止形が「り」で終わる（他の活用は「u段」で終止）のが特徴'
    ],
    studySteps: [
      '4語を暗記: あり・をり・はべり・いまそかり',
      '活用表を暗記: ら・り・り・る・れ・れ',
      '終止形が「り」であることに注意（「べし」等は終止形接続）'
    ]
  },
  'keiyoshi-katsuyo': {
    keyPoints: [
      '形容詞は「ク活用」と「シク活用」の2種類。終止形が「し」で終わるのがシク活用',
      '「かり活用」（補助活用）は助動詞が付くときに使う'
    ],
    studySteps: [
      '終止形で判別: 「〜し」→シク活用、それ以外→ク活用',
      'ク活用の活用表を覚える: く・く・し・き・けれ・○',
      'シク活用の活用表を覚える: しく・しく・し・しき・しけれ・○',
      '「かり活用」は助動詞接続時に使うことを理解する'
    ]
  },
  'keiyoshi-ku': {
    keyPoints: [
      '「よし」「多し」「高し」など、語幹に「し」を含まない形容詞',
      '補助活用（かり活用）: から・かり・○・かる・かれ・かれ'
    ],
    studySteps: [
      '本活用を暗記: く・く・し・き・けれ・○',
      '補助活用（かり活用）を暗記: から・かり・○・かる・かれ・かれ',
      '助動詞が付くときは「かり活用」を使うことを覚える'
    ]
  },
  'keiyoshi-shiku': {
    keyPoints: [
      '終止形が「〜し」で終わる。「うれし」「かなし」「をかし」など心情語が多い',
      'ク活用との見分け: 終止形で「し」の前に語幹があるか'
    ],
    studySteps: [
      '本活用を暗記: しく・しく・し・しき・しけれ・○',
      '補助活用: しから・しかり・○・しかる・しかれ・しかれ',
      '心情語（うれし・かなし・わびし等）はシク活用と覚える'
    ]
  },
  'jodoshi-jisei': {
    keyPoints: [
      '「き・けり」= 過去、「つ・ぬ」= 完了・強意、「たり・り」= 完了・存続',
      '「けり」は過去と詠嘆の2つの意味を持つ。文脈で判別'
    ],
    studySteps: [
      '6つの助動詞の意味と接続を暗記する',
      '「き」直接体験 vs「けり」伝聞・詠嘆 の違いを理解',
      '「つ・ぬ」の完了と強意の区別を理解',
      '「たり」の完了と存続の区別を理解'
    ]
  },
  'jodoshi-mu': {
    keyPoints: [
      '意味は「すいかかえ」（推量・意志・勧誘・仮定・婉曲）の5つ',
      '主語の人称で判別: 一人称→意志、二人称→勧誘、三人称→推量',
      '連体形で体言に接続 → 仮定 or 婉曲'
    ],
    studySteps: [
      '5つの意味を暗記（すいかかえ）',
      '主語の人称を確認する習慣をつける',
      '終止形（文末）→ 推量/意志/勧誘、連体形（体言前）→ 仮定/婉曲',
      '文脈から最も自然な意味を選ぶ練習'
    ]
  },
  'jodoshi-keri': {
    keyPoints: [
      '過去（伝聞的）と詠嘆（感動）の2つの意味',
      '地の文の叙述 → 過去、和歌・感動場面 → 詠嘆'
    ],
    studySteps: [
      '接続を暗記: 連用形に接続',
      '活用を暗記: ○・○・けり・ける・けれ・○',
      '過去 vs 詠嘆の判別法を身につける（地の文→過去、歌→詠嘆）'
    ]
  },
  'jodoshi-tari': {
    keyPoints: [
      '完了（〜してしまった）と存続（〜している）の2つの意味',
      '「寝たるに」＝寝ている状態で（存続）のように、状態が続いていれば存続'
    ],
    studySteps: [
      '接続を暗記: 連用形に接続',
      '活用を暗記: たら・たり・たり・たる・たれ・たれ',
      '完了 vs 存続の判別: 動作が終わった→完了、状態が続く→存続'
    ]
  },
  'jodoshi-nu': {
    keyPoints: [
      '完了の「ぬ」（連用形接続）と打消「ず」の連体形「ぬ」の識別が最重要',
      '「なむ」＝強意「ぬ」未然形＋推量「む」→「きっと〜だろう」'
    ],
    studySteps: [
      '接続を確認: 連用形に付く→完了「ぬ」、未然形に付く→打消「ず」',
      '活用を暗記: な・に・ぬ・ぬる・ぬれ・ね',
      '「なむ」「にけり」などの頻出パターンを覚える'
    ]
  },
  'jodoshi-tsu': {
    keyPoints: [
      '完了（〜してしまった）と強意（きっと〜）の2つの意味',
      '「てむ」「てき」など、「む」「き」と組み合わせるパターンが頻出'
    ],
    studySteps: [
      '接続を暗記: 連用形に接続',
      '活用を暗記: て・て・つ・つる・つれ・てよ',
      '「てむ」＝強意＋推量、「てき」＝完了＋過去のパターンを覚える'
    ]
  },
  'jodoshi-zu': {
    keyPoints: [
      '打消「〜ない」。未然形に接続',
      '連体形「ぬ」は完了の「ぬ」と紛らわしい → 接続で判別'
    ],
    studySteps: [
      '接続を暗記: 未然形に接続',
      '活用を暗記（特殊型）: ず・ず・ず・ぬ・ね・○',
      'ザリ活用（ざら・ざり・○・ざる・ざれ・ざれ）も覚える',
      '連体形「ぬ」と完了「ぬ」の識別法を身につける'
    ]
  },
  'jodoshi-ru': {
    keyPoints: [
      '受身・自発・可能・尊敬の4つの意味を持つ',
      '四段・ナ変・ラ変の未然形に「る」、それ以外に「らる」が接続'
    ],
    studySteps: [
      '接続を暗記: 未然形に接続（四段等→「る」、それ以外→「らる」）',
      '4つの意味の判別法を覚える: 「〜に」+動作主→受身、心情動詞→自発、可能/尊敬は文脈',
      '活用表を暗記（下二段型）'
    ]
  },
  'jodoshi-su': {
    keyPoints: [
      '使役（〜させる）と尊敬（〜なさる）の2つの意味',
      '四段・ナ変・ラ変の未然形に「す」、それ以外に「さす」が接続'
    ],
    studySteps: [
      '接続を暗記: 未然形に接続（四段等→「す」、それ以外→「さす」）',
      '使役 vs 尊敬の判別: 身分の高い人が主語→尊敬の可能性',
      '活用表を暗記（下二段型）'
    ]
  },
  'jodoshi-beshi': {
    keyPoints: [
      '推量・当然・可能・命令・意志・適当の6つの意味（「すいとうかめいてき」）',
      '終止形に接続（ラ変は連体形）'
    ],
    studySteps: [
      '6つの意味を暗記（すいとうかめいてき: 推量・当然・可能・命令・意志・適当）',
      '接続を暗記: 終止形（ラ変は連体形）に接続',
      '文脈と主語の人称から意味を絞り込む練習'
    ]
  },
  'jodoshi-nari': {
    keyPoints: [
      '断定「なり」（連体形・体言に接続）と伝聞推定「なり」（終止形に接続）の2つがある',
      '接続で判別するのが最も確実'
    ],
    studySteps: [
      '2つの「なり」の存在を理解する',
      '断定: 連体形・体言に接続「〜である」',
      '伝聞推定: 終止形に接続「〜らしい/〜と聞いている」',
      '接続を見て機械的に判別する練習'
    ]
  },
  'jodoshi-ri': {
    keyPoints: [
      '完了・存続の意味。サ変の未然形・四段の已然形に接続（「さみしいり」）',
      '接続が限定的なので判別しやすい'
    ],
    studySteps: [
      '接続を暗記: サ変未然形・四段已然形（「さみしいり」で覚える）',
      '活用を暗記（ラ変型）: ら・り・り・る・れ・れ',
      '「たり」との違いを理解する'
    ]
  },
  'jodoshi-suiryo': {
    keyPoints: [
      '推量系は「む・べし・らむ・けむ・まし・めり・なり（伝聞）」',
      'それぞれニュアンスが異なる: む=推量、べし=当然、らむ=現在推量、けむ=過去推量'
    ],
    studySteps: [
      '各助動詞の基本的な意味を一通り暗記',
      '接続の違いを整理する（未然形/終止形/連用形）',
      '文脈に応じた使い分けを理解する'
    ]
  },
  'jodoshi-hitei': {
    keyPoints: [
      '「ず」= 打消（〜ない）、「じ」= 打消推量（〜ないだろう）・打消意志（〜するまい）',
      '「ず」は最頻出。活用が特殊なので注意'
    ],
    studySteps: [
      '「ず」の活用を暗記（特殊型 + ザリ活用）',
      '「じ」の活用を暗記（○・○・じ・じ・じ・○）',
      '「ず」の連体形「ぬ」と完了「ぬ」の識別'
    ]
  },
  'jodoshi-ukemi-shieki-sonkei': {
    keyPoints: [
      '「る・らる」= 受身/自発/可能/尊敬、「す・さす」= 使役/尊敬',
      '接続: 四段・ナ変・ラ変→「る」「す」、その他→「らる」「さす」'
    ],
    studySteps: [
      '「る・らる」の4つの意味を暗記し判別法を身につける',
      '「す・さす」の2つの意味を暗記し判別法を身につける',
      '接続のルールを覚える（四段等→「る」「す」/その他→「らる」「さす」）'
    ]
  },
  'joshi-kaku': {
    keyPoints: [
      '「の」は主格（〜が）・連体修飾（〜の）・同格（〜で/〜である）の3用法',
      '「に」は場所・時・対象・原因など多義。文脈で判断'
    ],
    studySteps: [
      '格助詞の一覧を覚える（が・の・を・に・へ・と・より・から・にて・して）',
      '「の」の3用法を区別できるようにする',
      '「に」の多義性を理解し、文脈判断の練習'
    ]
  },
  'joshi-setsuzoku': {
    keyPoints: [
      '「ば」が最重要: 未然形＋ば＝仮定（もし〜なら）、已然形＋ば＝確定（〜ので/〜すると）',
      '接続助詞の前後で主語が変わることが多い → 読解の手がかり'
    ],
    studySteps: [
      '「ば」の2用法を確実に区別する（未然形＋ば vs 已然形＋ば）',
      '順接（ば）と逆接（ども・が・ものの）の違いを整理',
      '接続助詞で主語が変わるパターンを意識する'
    ]
  },
  'joshi-fuku-kakari': {
    keyPoints: [
      '係助詞「ぞ・なむ・や・か・こそ」は係り結びを引き起こす',
      '副助詞「だに・さへ・のみ」は意味を添える'
    ],
    studySteps: [
      '係助詞5つを暗記: ぞ・なむ・や・か → 連体形結び、こそ → 已然形結び',
      '副助詞の意味を覚える: だに=せめて/さえ、さへ=その上、のみ=だけ',
      '「もぞ」「もこそ」などの複合表現を覚える'
    ]
  },
  'joshi-shujoshi': {
    keyPoints: [
      '「な〜そ」= 禁止、「ばや」= 願望（一人称）、「なむ」= 願望（他者への）',
      '終助詞は文末に付いて話者の気持ちを表す'
    ],
    studySteps: [
      '禁止の「な〜そ」を覚える',
      '願望の「ばや」「なむ」「もがな」「てしがな」を覚える',
      '詠嘆の「かな」「かも」を覚える',
      '念押しの「かし」を覚える'
    ]
  },
  'kakari-musubi': {
    keyPoints: [
      '「ぞ・なむ・や・か」→ 結びは連体形、「こそ」→ 結びは已然形',
      '係り結びが崩れる（消滅する）パターンもある → 接続助詞の介入時'
    ],
    studySteps: [
      '5つの係助詞と結びの活用形を暗記する',
      '文中の係助詞を見つけたら、結びの語を探す練習',
      '係り結びの消滅パターンを理解する'
    ]
  },
  'keigo-sonkei': {
    keyPoints: [
      '動作の主体（する人）を高める。主語判定の最大の手がかり',
      '尊敬語動詞: おはす・のたまふ・御覧ず・きこしめす 等を暗記'
    ],
    studySteps: [
      '主な尊敬語動詞を暗記する（おはす・のたまふ・御覧ず等）',
      '「る・らる」「す・さす」「給ふ」による尊敬表現を覚える',
      '二重敬語（最高敬語）のパターンを理解する',
      '尊敬語から主語を判定する練習'
    ]
  },
  'keigo-kenjou': {
    keyPoints: [
      '動作の受け手（される人）を高める。「誰に対する動作か」で判断',
      '謙譲語動詞: 参る・まゐる・奏す・たてまつる 等を暗記'
    ],
    studySteps: [
      '主な謙譲語動詞を暗記する（参る・奏す・たてまつる等）',
      '補助動詞「たてまつる」「申す」の使い方を覚える',
      '謙譲語と尊敬語の違いを明確にする（動作主 vs 動作の受け手）',
      '謙譲語から「誰への動作か」を判定する練習'
    ]
  },
  'keigo-teinei': {
    keyPoints: [
      '聞き手・読み手に対する丁重さ。「はべり」「さぶらふ」の2語が中心',
      '地の文の丁寧語 → 作者の読者への敬意 or 語り手の態度'
    ],
    studySteps: [
      '「はべり」と「さぶらふ」を暗記する',
      '丁寧語が「誰に向けた敬意か」を理解する（聞き手/読み手）',
      '尊敬語・謙譲語・丁寧語の三分類を整理する'
    ]
  },
  'shikibetsu': {
    keyPoints: [
      '同じ形でも品詞・意味が異なる語の識別がテスト頻出',
      '「に」「なり」「る」「ぬ」などは接続と文脈で判別する'
    ],
    studySteps: [
      '紛らわしい語のペアを一覧で確認する',
      '各語の判別法（接続・文脈・前後の語）を覚える',
      '実際の古文で判別する練習を繰り返す'
    ]
  },
  // jodoshi-ganbou may not exist, but include just in case
  'jodoshi-ganbou': {
    keyPoints: [
      '「まほし」= 〜したい（未然形接続）、「たし」= 〜したい（連用形接続）',
      '「ごとし」= 〜のようだ（比喩）、「まし」= 反実仮想'
    ],
    studySteps: [
      '願望の「まほし」「たし」の接続を覚える',
      '「まし」の反実仮想（もし〜なら〜だろうに）を理解する',
      '「ごとし」の接続と意味を覚える'
    ]
  }
};

// --- Section priority mapping by heading pattern ---
function getPriority(heading) {
  // essential: 見分け方、判別、識別
  if (/見分け方|判別|識別|法則/.test(heading)) return 'essential';
  // essential: 意味の判別
  if (/意味の判別|意味$/.test(heading)) return 'essential';
  // essential: 2つの用法、多義性
  if (/2つの|多義性|3つの作り方/.test(heading)) return 'essential';
  // important: 活用表、接続と活用、一覧
  if (/活用表|接続と活用|一覧|活用の種類|主な|法則/.test(heading)) return 'important';
  // important: specific grammar items
  if (/係助詞とは|係り結びとは|係り結びの例/.test(heading)) return 'important';
  // supplementary: とは、代表的な、注意、複合、消滅
  if (/とは$|代表的な|複合|消滅|違い|テスト|出題|組み合わせ|判別法|出現/.test(heading)) return 'supplementary';
  // important by default for named grammar items (き, けり, etc.)
  if (/^[「（]/.test(heading) || /の詳細|の逆接/.test(heading)) return 'important';
  // default
  return 'supplementary';
}

// Process each file
const files = fs.readdirSync(dir).filter(f => f.endsWith('.json'));
let updated = 0;

files.forEach(file => {
  const filePath = path.join(dir, file);
  const d = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
  const id = d.id;

  // Add keyPoints and studySteps
  const data = topicData[id];
  if (data) {
    d.keyPoints = data.keyPoints;
    d.studySteps = data.studySteps;
  }

  // Add priority to sections
  d.sections.forEach(section => {
    section.priority = getPriority(section.heading);
  });

  fs.writeFileSync(filePath, JSON.stringify(d, null, 2) + '\n', 'utf-8');
  updated++;

  const prioSummary = d.sections.map(s => `${s.priority}:${s.heading}`).join(', ');
  console.log(`${file}: ${data ? 'keyPoints+studySteps+' : ''}priority [${prioSummary}]`);
});

console.log(`\nUpdated ${updated} files.`);
